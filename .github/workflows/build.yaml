name: Build and deploy Nexar POS

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch of nexar-pos repo to build"
        required: true
        default: "main"
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Nexar POS Docker Image
        env:
          DOCKER_HUB_REPO: nexarift/nexar-pos
        run: |
          set -e

          # Immutable tag for rollback
          SHORT_SHA="${GITHUB_SHA::7}"

          # apps.json (official Frappe pattern)
          APPS_JSON='[
            {
              "url": "https://github.com/frappe/frappe.git",
              "branch": "version-15"
            },
            {
              "url": "https://github.com/frappe/erpnext.git",
              "branch": "version-15"
            },
            {
              "url": "https://github.com/frappe/hrms.git",
              "branch": "version-15"
            },
            {
              "url": "https://github.com/NexaRift25/nexarPOS.git",
              "branch": "main"
            }
          ]'

          # Validate apps.json early
          echo "$APPS_JSON" | jq .

          # Encode apps.json
          APPS_JSON_BASE64="$(echo "$APPS_JSON" | base64 -w 0)"

          # Build & push image
          docker buildx build \
            --platform linux/amd64 \
            --build-arg FRAPPE_PATH=https://github.com/frappe/frappe.git \
            --build-arg FRAPPE_BRANCH=version-15 \
            --build-arg PYTHON_VERSION=3.11.9 \
            --build-arg NODE_VERSION=20.19.2 \
            --build-arg APPS_JSON_BASE64="$APPS_JSON_BASE64" \
            --cache-from=type=gha \
            --cache-to=type=gha,mode=max \
            --tag "${DOCKER_HUB_REPO}:latest" \
            --tag "${DOCKER_HUB_REPO}:${SHORT_SHA}" \
            --label org.opencontainers.image.revision="$GITHUB_SHA" \
            --label org.opencontainers.image.source="$GITHUB_REPOSITORY" \
            --push .
